document.addEventListener('DOMContentLoaded', () => {
    console.log("Kurly clone script started!");

    // ==================== Header Functions ====================
    try {
        const marketKurlyBtn = document.getElementById('market-kurly');
        const beautyKurlyBtn = document.getElementById('beauty-kurly');
        const menuItems = document.querySelectorAll('.menu-item');

        function handleMenuClick(event) {
            menuItems.forEach(item => item.classList.remove('active'));
            event.target.classList.add('active');
        }

        marketKurlyBtn.addEventListener('click', handleMenuClick);
        beautyKurlyBtn.addEventListener('click', handleMenuClick);

        // ‚ñº‚ñº‚ñº Ïπ¥ÌÖåÍ≥†Î¶¨ Î©îÎâ¥ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏàòÏ†ï ‚ñº‚ñº‚ñº
        const categoryMenuContainer = document.querySelector('.category-menu-container');
        const categoryBtn = document.querySelector('.category-btn');
        const categoryWrapper = document.querySelector('.category-wrapper');

        categoryMenuContainer.addEventListener('mouseenter', () => {
            categoryWrapper.style.display = 'block';
            categoryBtn.classList.add('active');
        });

        categoryMenuContainer.addEventListener('mouseleave', () => {
            categoryWrapper.style.display = 'none';
            categoryBtn.classList.remove('active');
        });
        // ‚ñ≤‚ñ≤‚ñ≤ Ïπ¥ÌÖåÍ≥†Î¶¨ Î©îÎâ¥ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏàòÏ†ï ÎÅù ‚ñ≤‚ñ≤‚ñ≤

        console.log("Header functions initialized successfully.");
    } catch (error) {
        console.error("Error initializing header functions:", error);
    }

    // ==================== Main Content Functions ====================
    if (typeof Swiper === 'undefined') {
        console.error("Swiper library is not loaded.");
    } else {
        try {
            new Swiper('.main-banner-swiper', {
                loop: true,
                autoplay: { delay: 3500, disableOnInteraction: false },
                pagination: { el: '.main-banner-swiper .swiper-pagination', clickable: true },
                navigation: { nextEl: '.main-banner-swiper .swiper-button-next', prevEl: '.main-banner-swiper .swiper-button-prev' },
            });
            console.log("Main banner swiper initialized.");
        } catch (error) {
            console.error("Error initializing main banner swiper:", error);
        }
    }

    // ==================== Finite Scroll & Dynamic Section Creation ====================
    let isLoading = false;
    let sectionsRendered = 0;
    const TOTAL_SECTIONS = 50;
    const productSectionsWrapper = document.getElementById('product-sections-wrapper');
    const loader = document.querySelector('.loader');
    const footer = document.getElementById('main-footer');

    const sectionTitles = [
        "‚ú® MDÏùò Í∞ïÎ†• Ï∂îÏ≤ú ÏÉÅÌíà!", "üèÜ ÏßÄÍ∏à Í∞ÄÏû• Ïù∏Í∏∞ÏûàÏñ¥Ïöî", "‚è∞ ÎÜìÏπòÎ©¥ ÌõÑÌöåÌï† Í∞ÄÍ≤©!",
        "üõí Ïû•Î∞îÍµ¨Îãà Îã®Í≥®ÌÖú Î™®Ïùå", "üíñ Ïû¨Íµ¨Îß§Ïú® ÎÜíÏùÄ ÏÉÅÌíà", "üî• Ïã§ÏãúÍ∞Ñ Ïù∏Í∏∞ Í∏âÏÉÅÏäπ",
    ];
    
    const rankingCategories = ["Í∞ÑÌé∏Ïãù TOP50", "Í∞ÑÏãù TOP50", "Î≤†Ïù¥Ïª§Î¶¨ TOP50", "Î∞òÏ∞¨ TOP50", "Ïú†Ï†úÌíà TOP50", "Ï£ºÎ∞© TOP50", "Î∑∞Ìã∞ TOP50"];
    
    const bannerImages = ["assets/banner1.png", "assets/banner2.jpg", "assets/banner3.png", "assets/banner4.png", "assets/banner5.png"];

    const sampleProducts = [
        { name: '[KF365] 1+Îì±Í∏â Î¨¥Ìï≠ÏÉùÏ†ú ÎåÄÎûÄ 20Íµ¨', imgSrc: 'assets/sang-1.jpg', price: 6900, discount: 10 },
        { name: '[Ïó∞ÏÑ∏Ïö∞Ïú†] Ï†ÑÏö©Î™©Ïû•Ïö∞Ïú† 900mL', imgSrc: 'assets/sang-2.jpg', price: 2280, discount: 0 },
        { name: '[ÌíÄÎ¨¥Ïõê] ÎèôÎ¨ºÎ≥µÏßÄ Î™©Ï¥àÎûÄ 15Íµ¨', imgSrc: 'assets/sang-3.jpg', price: 7500, discount: 15 },
        { name: '[ÌîÑÎ°úÏ†ùÌä∏ÌïòÎ£®] Í≥†ÏÜåÌïú ÌïòÎ£®Í≤¨Í≥º', imgSrc: 'assets/sang-4.jpg', price: 11900, discount: 0 },
        { name: '[Î∏åÎùºÏö¥] ÏÑ±Î∂ÑÏù¥ Îã§Î•∏ Î¨ºÌã∞Ïäà 10Í∞úÏûÖ', imgSrc: 'assets/sang-5.jpg', price: 18900, discount: 0 },
        { name: '[Ï¢ÖÍ∞Ä] ÏïÑÏÇ≠ ÏπºÏßë Ìè¨Í∏∞ÍπÄÏπò 4kg', imgSrc: 'assets/sang-6.jpg', price: 29800, discount: 20 },
        { name: '[ÌååÎ®∏Ïä§] GAP ÏÉ§Ïù∏Î®∏Ïä§Ï∫£ 1.5kg', imgSrc: 'assets/sang-7.jpg', price: 25900, discount: 0 },
        { name: '[ÌïòÎ¶º] ÎèôÎ¨ºÎ≥µÏßÄ Îã≠Í∞ÄÏä¥ÏÇ¥ 1kg', imgSrc: 'assets/sang-8.jpg', price: 15900, discount: 10 },
        { name: '[Ï†úÏ£º ÏÇºÎã§Ïàò] Í∑∏Î¶∞ 2L (6Í∞úÏûÖ)', imgSrc: 'assets/sang-9.jpg', price: 6300, discount: 0 },
        { name: '[Ïò§ÎöúÍ∏∞] ÏßÑÎùºÎ©¥ Îß§Ïö¥Îßõ (5Í∞úÏûÖ)', imgSrc: 'assets/sang-10.jpg', price: 3850, discount: 5 },
        { name: '[ÌñáÎ∞ò] Îß§ÏùºÏû°Í≥°Î∞• 210g (12Í∞úÏûÖ)', imgSrc: 'assets/sang-11.jpg', price: 17900, discount: 0 },
        { name: '[ÏÑúÏö∏Ïö∞Ïú†] Ï≤¥Îã§ÏπòÏ¶à 50Îß§ÏûÖ', imgSrc: 'assets/sang-12.jpg', price: 12900, discount: 10 },
    ];
    
    function initializeProductSwiper(swiperSelector, prevBtnSelector, nextBtnSelector) {
        if (typeof Swiper === 'undefined' || !document.querySelector(swiperSelector)) return;
        try {
            new Swiper(swiperSelector, {
                slidesPerView: 4,
                spaceBetween: 18,
                slidesPerGroup: 4,
                navigation: {
                    nextEl: nextBtnSelector,
                    prevEl: prevBtnSelector,
                },
            });
            console.log(`Product swiper initialized for ${swiperSelector}`);
        } catch (error) {
            console.error(`Failed to initialize swiper for ${swiperSelector}:`, error);
        }
    }

    function fetchProducts(count) {
        return new Promise(resolve => {
            setTimeout(() => {
                const products = [];
                for (let i = 0; i < count; i++) {
                    products.push(sampleProducts[Math.floor(Math.random() * sampleProducts.length)]);
                }
                resolve(products);
            }, 500);
        });
    }
    
    const observer = new IntersectionObserver((entries, obs) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('is-visible');
                obs.unobserve(entry.target);
            }
        });
    }, { threshold: 0.1 });

    async function createAndAppendProductSection() {
        const productsToFetch = 12;
        const newProducts = await fetchProducts(productsToFetch);
        const newSection = document.createElement('section');
        newSection.className = 'product-section';
        const title = (sectionsRendered === 0) ? "Ïù¥ ÏÉÅÌíà Ïñ¥ÎïåÏöî?" : sectionTitles[Math.floor(Math.random() * sectionTitles.length)];
        const swiperId = `product-swiper-${sectionsRendered}`;
        const swiperSelector = `.${swiperId}`;
        const prevBtnSelector = `.${swiperId}-prev`;
        const nextBtnSelector = `.${swiperId}-next`;

        newSection.innerHTML = `
            <div class="section-container">
                <h2 class="section-title">${title}</h2>
                <div class="swiper product-swiper ${swiperId}">
                    <div class="swiper-wrapper"></div>
                </div>
                <div class="swiper-button-prev ${swiperId}-prev"></div>
                <div class="swiper-button-next ${swiperId}-next"></div>
            </div>
        `;
        productSectionsWrapper.appendChild(newSection);
        const targetSwiperWrapper = newSection.querySelector('.swiper-wrapper');

        if (!targetSwiperWrapper) return;

        newProducts.forEach(product => {
            const productItem = createProductItem(product);
            productItem.classList.add('swiper-slide');
            targetSwiperWrapper.appendChild(productItem);
            observer.observe(productItem);
        });
        
        initializeProductSwiper(swiperSelector, prevBtnSelector, nextBtnSelector);
    }

    async function createAndAppendRankingSection() {
        const rankingProducts = await fetchProducts(9);
        const newSection = document.createElement('section');
        newSection.className = 'product-section ranking-section';
        const tabHtml = rankingCategories.map((cat, index) => `<button class="ranking-tab ${index === 0 ? 'active' : ''}">${cat}</button>`).join('');
        const newGrid = document.createElement('div');
        newGrid.className = 'ranking-grid';

        rankingProducts.forEach((product, index) => {
            const rankingItem = createRankingItem(product, index + 1);
            newGrid.appendChild(rankingItem);
            observer.observe(rankingItem);
        });

        newSection.innerHTML = `<div class="section-container"><h2 class="section-title">Ïò§ÎäòÏùò Ïπ¥ÌÖåÍ≥†Î¶¨ Îû≠ÌÇπ</h2><div class="ranking-tabs">${tabHtml}</div></div>`;
        newSection.querySelector('.section-container').appendChild(newGrid);
        productSectionsWrapper.appendChild(newSection);
    }

    function createAndAppendBannerSection() {
        const newSection = document.createElement('section');
        newSection.className = 'product-section banner-section';
        const randomBannerSrc = bannerImages[Math.floor(Math.random() * bannerImages.length)];
        newSection.innerHTML = `<div class="section-container"><a href="#"><img src="${randomBannerSrc}" alt="Ï§ëÍ∞Ñ Í¥ëÍ≥† Î∞∞ÎÑà"></a></div>`;
        productSectionsWrapper.appendChild(newSection);
    }
    
    function createProductItem(product) {
        const item = document.createElement('div');
        item.className = 'product-item';
        let priceHTML = product.discount > 0
            ? `<div class="product-price"><span class="discount-rate">${product.discount}%</span><span class="final-price">${Math.round(product.price * (100 - product.discount) / 100).toLocaleString()}Ïõê</span></div><p class="original-price">${product.price.toLocaleString()}Ïõê</p>`
            : `<div class="product-price"><span class="final-price">${product.price.toLocaleString()}Ïõê</span></div>`;
        const cartBtnHTML = `<button class="add-to-cart-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg> Îã¥Í∏∞</button>`;
        item.innerHTML = `<a href="#"><div class="product-img"><img src="${product.imgSrc}" alt="${product.name}"></div></a> ${cartBtnHTML} <div class="product-info"><a href="#"><h3 class="product-name">${product.name}</h3>${priceHTML}</a></div>`;
        return item;
    }

    function createRankingItem(product, rank) {
        const item = document.createElement('div');
        item.className = 'product-item ranking-item';
        let priceHTML = product.discount > 0
            ? `<div class="product-price"><span class="discount-rate">${product.discount}%</span><span class="final-price">${Math.round(product.price * (100 - product.discount) / 100).toLocaleString()}Ïõê</span></div><p class="original-price">${product.price.toLocaleString()}Ïõê</p>`
            : `<div class="product-price"><span class="final-price">${product.price.toLocaleString()}Ïõê</span></div>`;
        const cartBtnHTML = `<button class="add-to-cart-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg> Îã¥Í∏∞</button>`;
        item.innerHTML = `<span class="rank-number">${rank}</span><div class="product-img-wrapper"><a href="#"><img src="${product.imgSrc}" alt="${product.name}"></a></div><div class="product-info"><a href="#"><h3 class="product-name">${product.name}</h3>${priceHTML}</a>${cartBtnHTML}</div>`;
        return item;
    }
    
    async function loadMoreContent() {
        if (isLoading) return;
        isLoading = true;
        loader.style.display = 'block';

        try {
            const nextSectionIndex = sectionsRendered + 1;
            
            if (nextSectionIndex > 1 && nextSectionIndex % 7 === 0) {
                createAndAppendBannerSection();
            } else if (nextSectionIndex > 1 && nextSectionIndex % 5 === 0) {
                await createAndAppendRankingSection();
            } else {
                await createAndAppendProductSection();
            }
            sectionsRendered = nextSectionIndex;
        } catch (error) {
            console.error("ÏΩòÌÖêÏ∏† Î°úÎî© Ï§ë Ïò§Î•ò Î∞úÏÉù:", error);
        } finally {
            loader.style.display = 'none';
            isLoading = false;
        }
    }

    const handleScroll = () => {
        if (sectionsRendered >= TOTAL_SECTIONS) {
            if (footer && footer.style.display === 'none') {
                footer.style.display = 'block';
                setTimeout(() => footer.classList.add('visible'), 100);
            }
            window.removeEventListener('scroll', handleScroll);
            return;
        }

        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500 && !isLoading) {
            loadMoreContent();
        }
    };

    window.addEventListener('scroll', handleScroll);

    // Ï¥àÍ∏∞ Î°úÎìúÎ•º loadMoreContent Ìï®ÏàòÎ•º ÌÜµÌï¥ ÏãúÏûë
    loadMoreContent();
});

